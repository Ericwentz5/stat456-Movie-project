---
title: "Incorporating Genre and Classifying"
format: html
---

### Setup
```{r message=FALSE}
library(tidyverse)
library(ellmer)
library(dplyr)
library(tibble)
library(patchwork)
library(fastDummies)
library(caret)
library(pROC)

imdb <- read_tsv("data/raw/title.basics.tsv")
movies_10k_w_llm <- read_csv("data/raw/10k_pre-2010-01-01-w-llm-classification.csv")
top_movies <- read_csv("data/top_10000_movies.csv")
```


# Training logit model
```{r message=FALSE}
unique(imdb$titleType)

imdb <- imdb %>% filter(titleType == "movie")

# separating out genre arrays
imdb <- imdb %>%
  mutate(
    genres = str_split(genres, ",")
  ) %>%
  mutate(
    genre1 = map_chr(genres, ~ .x[1] %||% NA_character_),
    genre2 = map_chr(genres, ~ .x[2] %||% NA_character_),
    genre3 = map_chr(genres, ~ .x[3] %||% NA_character_)
  )

# combining imdb and tmdb data
combined_movies <- movies_10k_w_llm %>% mutate(tconst = imdb_id) %>% left_join(imdb, by = "tconst")

# remove movies with na for genre1 and add roi
combined_movies_filtered <- combined_movies %>% filter(!is.na(genre1)) %>% mutate(roi = revenue/budget)

unique(combined_movies_filtered$genre1)

# create genre dummy variables
all_genres <- c("Drama", "Crime", "Biography", "Adventure", "Action", "Animation",
                "Comedy", "Horror", "Mystery", "Western", "Fantasy", "Thriller",
                "Sci-Fi", "Romance", "Film-Noir", "Family", "Musical", "Documentary")

combined_movies_filtered$genre1 <- factor(combined_movies_filtered$genre1,
                                          levels = all_genres)

combined_movies_filtered <- combined_movies_filtered %>%
  fastDummies::dummy_cols(select_columns = "genre1", remove_first_dummy = FALSE)

# logistic Regression to see genres
model_logit1 <- glm(
  llm_class_final ~ vote_average + popularity + log(roi) + runtime + genre1,
  data = combined_movies_filtered,
  family = binomial
)

summary(model_logit1)

table(combined_movies_filtered$genre1)

# logistics regression with only genres that are significant and have suitable sample size
model_logit2 <- glm(llm_class_final ~ vote_average + popularity + log(budget) + log(roi) + runtime + genre1_Biography + genre1_Action + genre1_Comedy + genre1_Horror + genre1_Fantasy,
                   data = combined_movies_filtered,
                   family = binomial)
summary(model_logit2)

# including log(budget) biases toward found footage/horror movies
```

# Testing logit prediction on 30% of training data before new data
```{r}
# set seed for reproducibility
set.seed(123)

# create index (e.g., 70% train / 30% test)
train_idx <- createDataPartition(
  combined_movies_filtered$llm_class_final,
  p = 0.7,
  list = FALSE
)

# bisecting data
train_data <- combined_movies_filtered[train_idx, ]
test_data  <- combined_movies_filtered[-train_idx, ]

# checking balance
prop.table(table(train_data$llm_class_final))
prop.table(table(test_data$llm_class_final))

# train logit model with training data
logit_train <- glm(llm_class_final ~ vote_average + popularity + log(budget) + log(roi) + runtime + genre1_Biography + genre1_Action + genre1_Comedy + genre1_Horror + genre1_Fantasy, 
                   data = train_data, 
                   family = binomial)
summary(logit_train)

# predict logit on test set
test_data <- test_data %>%
  mutate(
    pred_prob_logit = predict(logit_train, newdata = ., type = "response"),
    pred_class_logit = if_else(pred_prob_logit >= 0.351, 1, 0)
  )
```


# Predicting with logit model
```{r}
top_movies <- top_movies %>%
  left_join(imdb, by = c("imdb_id" = "tconst"))

# filter out training data and also movie released in past 6 months
top_movies_post2009 <- top_movies %>%
  filter(release_date >= as.Date("2010-01-01"), release_date < as.Date("2025-04-01"), budget > 10, revenue > 10) %>%
  mutate(roi = revenue/budget) %>%
  mutate(
    log_budget = log(budget + 1),
    log_roi = log(roi + 1)
  )

top_movies_post2009$genre1 <- factor(top_movies_post2009$genre1, levels = all_genres)

top_movies_post2009 <- top_movies_post2009 %>%
  fastDummies::dummy_cols(select_columns = "genre1", remove_first_dummy = FALSE)

top_movies_post2009_preds <- top_movies_post2009 %>%
  mutate(
    pred_prob_logit = predict(model_logit2, newdata = ., type = "response"),
    pred_class_logit = if_else(pred_prob_logit >= 0.351, 1, 0)
  )

vif(model_logit2)
```

# Testing rf prediction on 30% of training data before new data
```{r}
train_data$llm_class_final <- as.factor(train_data$llm_class_final)
test_data$llm_class_final  <- as.factor(test_data$llm_class_final)

rf_train <- randomForest(
  llm_class_final ~ vote_average + popularity + log_budget + log_roi +
    runtime + genre1_Biography + genre1_Action + genre1_Comedy +
    genre1_Horror + genre1_Fantasy,
  data = train_data,
  ntree = 500,
  mtry = 4
)

test_data$pred_prob_rf <- predict(
  rf_train,
  newdata = test_data,
  type = "prob"
)[, 2]

test_data$pred_class_rf <- if_else(test_data$pred_prob_rf >= 0.351, 1, 0)

# evaluate models
confusionMatrix(
  factor(test_data$pred_class_logit),
  factor(test_data$llm_class_final)
)

confusionMatrix(
  factor(test_data$pred_class_rf),
  factor(test_data$llm_class_final)
)

roc_logit <- roc(test_data$llm_class_final, test_data$pred_prob_logit)
roc_rf    <- roc(test_data$llm_class_final, test_data$pred_prob_rf)

auc(roc_logit)
auc(roc_rf)

# ensemble model
test_data <- test_data %>%
  mutate(
    pred_prob_ensemble = (pred_prob_logit + pred_prob_rf) / 2,
    pred_class_ensemble = if_else(pred_prob_ensemble >= 0.351, 1, 0)
  )

confusionMatrix(
  factor(test_data$pred_class_ensemble),
  factor(test_data$llm_class_final)
)

roc_ens <- roc(test_data$llm_class_final, test_data$pred_prob_ensemble)
auc(roc_ens)

coords(roc_rf, "best", ret = "threshold")
```


# Random forest
```{r}
library(randomForest)
combined_movies_filtered$llm_class_final <- as.factor(combined_movies_filtered$llm_class_final)

combined_movies_filtered <- combined_movies_filtered %>%
  mutate(
    log_budget = log(budget + 1),
    log_roi = log(roi + 1)
  )

rf_model <- randomForest(
  llm_class_final ~ vote_average + popularity + log_budget + log_roi + runtime + genre1_Biography + genre1_Action + genre1_Comedy + genre1_Horror + genre1_Fantasy,
  data = combined_movies_filtered,
  ntree = 500,
  mtry = 4
)

rf_model

# evaluate
importance(rf_model)
varImpPlot(rf_model)

# predict
top_movies_post2009_preds$pred_prob_rf <- predict(rf_model, top_movies_post2009, type = "prob")[,2]
top_movies_post2009_preds$pred_class_rf <- if_else(top_movies_post2009_preds$pred_prob_rf > 0.351, 1, 0)


# ensemble model
top_movies_post2009_preds <- top_movies_post2009_preds %>% mutate(ensemble_prob = (pred_prob_logit + pred_prob_rf)/2)
top_movies_post2009_preds$ensemble_class <- if_else(top_movies_post2009_preds$ensemble_prob > 0.351, 1, 0)


# for viz: labelled and faceted bar plot (?) of highest and lowest prob movies for each of the three models
# also include key model selection stats and confusion matrix
# also include clean mean model probably latex

# also include confusion matrix for manual verification
```




